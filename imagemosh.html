<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Mosh</title>
    <style>
        :root {
            --accent: #b4a0f8;
            --background: #1a1a1a;
            --foreground: #2a2a2a;
            --inputground:#888888;
            --textground: #e0e0e0;
            --resizer: #333;
            --roundness: 15px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; color: var(--textground); }
        body { font-family: system-ui, -apple-system, sans-serif; background: var(--background); overflow: hidden; }
        #app { display: grid; grid-template-columns: 50% 50%; height: 100vh; position: relative; }
        #p_left { display: flex; flex-direction: column; overflow: hidden; container-type: inline-size; container-name: left-panel; }
        #p_right { display: flex; flex-direction: column; align-items: center; justify-content: center; overflow: hidden; padding: 20px; }
        #p_left > div:first-child, #p_left > div:last-child { padding: 15px; }
        #p_left > div:first-child { padding-bottom: 0px; }
        #p_left > div:last-child { padding-top: 0px; }
        #f_list { max-height: 0; overflow: hidden; transition: max-height 0.3s, padding-top 0.25s; display: flex; flex-direction: column; gap: 5px; }
        #f_list.expanded { padding-top: 15px; max-height: 50vh; overflow-y: auto; }
        .filter-item { display: flex; align-items: center; gap: 8px; padding: 10px; background: var(--foreground); border-radius: var(--roundness); }
        .drag-handle { cursor: grab; user-select: none; display: inline-flex; align-items: center; justify-content: center;}
        .filter-item > * { flex: 0.5; }
        .filter-item input[type="text"] { flex: 9; background: var(--background); padding: 5px 10px; border: none; border-radius: calc(var(--roundness) - 10px); }
        #e_container { flex: 1; display: flex; flex-direction: column; padding: 15px; padding-top: 5px; overflow: hidden; background: var(--background); }
        #e_container > div:first-child { margin-bottom: 5px; font-size: 12px; }
        #e { flex: 1; background: var(--foreground); color: var(--inputground); border: none; padding: 15px; font-family: monospace; font-size: 14px; resize: none; border-radius: var(--roundness); outline: none; }
        .dynamic-row, .static-row { display: flex; border-radius: var(--roundness); overflow: hidden; }
        .static-row { border-radius: 0; flex: 1; }
        button, #f_select { padding: 12px; background: var(--foreground); border: none; cursor: pointer; font-size: 14px; flex: 1; min-width: 0; }
        .row-span { padding: 12px; flex: none; background-color: var(--accent); color: var(--background); font-size: 14px; min-width: 0; display: inline-flex; align-items: center; filter: grayscale(0.5); }
        #f_select { background: var(--accent); color: var(--background); text-align-last: center; text-align: center; appearance: none; -webkit-appearance: none; -moz-appearance: none; }
        button:hover:not(:disabled) { filter:invert(0.1) }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        #uz { border: 2px dashed var(--textground); padding: 60px; text-align: center; cursor: pointer; border-radius: var(--roundness); margin-bottom: 15px; width: 100%; max-width: 400px; position: relative; overflow: hidden; }
        #uz:hover { border-color: var(--accent); color: var(--accent); }
        #ui { position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%; z-index: 10; }
        #canvas-create-ui { display: flex; border-radius: var(--roundness); overflow: hidden; }
        #canvas-create-ui input { background: var(--foreground); color: var(--inputground);border: none; padding: 8px 12px; outline: none; width: 100px; }
        #canvas-create-ui button { background: var(--accent); color: var(--background); flex: none; padding: 8px 16px; }
        #canvas-create-ui.hidden { display: none; }
        #canvas { max-width: 100%; max-height: 100%; image-rendering: pixelated; border-radius: var(--roundness);}
        @media (min-width: 769px) {
            #resizer { position: absolute; left: 50%; width: 4px; height: 100%; background: var(--resizer); cursor: col-resize; transform: translateX(-2px); z-index: 1000; }
            #resizer:hover { background: var(--accent); }
        }
        @media (max-width: 768px) {
            body { overflow-y: auto; }
            #app { display: flex; flex-direction: column; height: auto; min-height: 100vh; }
            #resizer { display: none; }
            #p_right { width: 100%; order: 1; border-bottom: 5px solid var(--resizer); }
            #p_left { width: 100%; min-height: 100vh; order: 2; border-right: none; }
            .drag-handle { display: none; }
        }
        @container left-panel (max-width: 450px) {
            .dynamic-row { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div id="app">
        <div id="resizer"></div>
        <div id="p_left">
            <div>
                <div class="dynamic-row">
                    <div class="static-row">
                        <select id="f_select"></select>
                        <button id="f_manager" title="Open Filter Manager">â˜°</button>
                    </div>
                    <div class="static-row">
                        <button id="f_new" title="Add new filter">+</button>
                        <button id="f_ck" title="Remove filter">-</button>
                        <button id="f_import" title="Import filters from a file">â¤“</button>
                        <button id="f_export" title="Export filter to a file">â¤’</button>
                        <button id="f_up" title="Move filter up" onclick="moveFilterUp(currentFilterIdx)">â–²</button>
                        <button id="f_down" title="Move filter down" onclick="moveFilterDown(currentFilterIdx)">â–¼</button>
                    </div>
                </div>
                <div id="f_list"></div>
            </div>

            <div id="e_container">
                <div>
                    Defined: (r,g,b,a,x,y,w,h,i,p), put(r,g,b,a,x,y)
                </div>
                <textarea id="e" spellcheck="false"></textarea>
            </div>

            <div>
                <div class="dynamic-row">
                    <div class="static-row">
                        <span class="row-span">Canvas:</span>
                        <button id="c_clear" disabled>ðŸ—‘</button>
                        <button id="c_reset" disabled>â†»</button>
                        <button id="c_apply" disabled>â–¶</button>
                    </div>
                    <div class="static-row">
                        <span class="row-span">All filters:</span>
                        <button id="c_export">â¤’</button>
                        <button id="c_replace">â¤“</button>
                    </div>

                </div>
            </div>
        </div>

        <div id="p_right">
            <div id="uz">
                drag n drop here or click here
                <input type="file" id="ui" accept="image/*">
            </div>
            <div id="canvas-create-ui">
                <input type="text" id="canvas_dims" placeholder="WxH" value="512x512">
                <button id="canvas_new">+</button>
            </div>
            <canvas id="canvas" style="display: none;"></canvas>
        </div>
    </div>

    <script>
        const $ = id => document.getElementById(id);
        const ui = {
            uz: $('uz'), ui: $('ui'), editor: $('e'), f_select: $('f_select'), f_list: $('f_list'),
            f_manager: $('f_manager'), f_new: $('f_new'), f_import: $('f_import'), f_ck: $('f_ck'),
            f_export: $('f_export'), c_clear: $('c_clear'), c_reset: $('c_reset'), c_apply: $('c_apply'),
            c_export: $('c_export'), c_replace: $('c_replace'), canvas: $('canvas'),
            canvas_dims: $('canvas_dims'), canvas_new: $('canvas_new'), canvas_create_ui: $('canvas-create-ui')
        };

        let originalImage = null, originalImageData = null, currentFilterIdx = 0, listExpanded = false;
        let filters = [{name: 'Main', on: true, data: '// Place pixel at original position\nput(r, g, b, a, x, y);'}];
        const activeBlobURLs = new Set();

        const updateFilterSelect = () => {
            ui.f_select.innerHTML = '';
            filters.forEach((f, idx) => {
                const opt = document.createElement('option');
                opt.value = idx;
                opt.textContent = f.name;
                opt.selected = idx === currentFilterIdx;
                ui.f_select.appendChild(opt);
            });
        };

        const updateFilterList = () => {
            ui.f_list.innerHTML = '';
            filters.forEach((f, idx) => {
                const item = document.createElement('div');
                item.className = 'filter-item';
                item.draggable = true;
                item.dataset.idx = idx;
                item.innerHTML = `<input type="checkbox" ${f.on ? 'checked' : ''}><input type="text" value="${f.name}"><span class="drag-handle">â˜°</span>`;
                
                const checkbox = item.querySelector('input[type="checkbox"]');
                checkbox.addEventListener('change', () => f.on = checkbox.checked);
                
                const nameInput = item.querySelector('input[type="text"]');
                nameInput.addEventListener('change', () => {
                    f.name = nameInput.value;
                    updateFilterSelect();
                });
                
                item.addEventListener('click', e => {
                    if (e.target.tagName !== 'INPUT') {
                        saveCurrentFilterCode();
                        currentFilterIdx = idx;
                        ui.f_select.value = currentFilterIdx;
                        loadFilterCode();
                    }
                });
                
                item.addEventListener('dragstart', e => {
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/plain', idx);
                });
                
                item.addEventListener('dragover', e => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                });
                
                item.addEventListener('drop', e => {
                    e.preventDefault();
                    const fromIdx = parseInt(e.dataTransfer.getData('text/plain'));
                    const toIdx = idx;
                    if (fromIdx !== toIdx) {
                        const currentFilterName = filters[currentFilterIdx].name;
                        const [moved] = filters.splice(fromIdx, 1);
                        filters.splice(toIdx, 0, moved);
                        currentFilterIdx = filters.findIndex(f => f.name === currentFilterName);
                        updateFilterSelect();
                        updateFilterList();
                    }
                });
                
                ui.f_list.appendChild(item);
            });
        };

        const saveCurrentFilterCode = () => filters[currentFilterIdx].data = ui.editor.value;
        const loadFilterCode = () => ui.editor.value = filters[currentFilterIdx].data;

        const downloadJSON = (json, filename) => {
            const blob = new Blob([json], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            activeBlobURLs.add(url);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            setTimeout(() => {
                URL.revokeObjectURL(url);
                activeBlobURLs.delete(url);
            }, 100);
        };

        const validateFilters = filters => {
            if (!Array.isArray(filters) || !filters.length) throw new Error('Invalid filter file: expected non-empty array');
            filters.forEach(f => {
                if (!f.name || typeof f.on !== 'boolean' || typeof f.data !== 'string')
                    throw new Error('Invalid filter structure: missing name, on, or data');
            });
        };

        const createBlankCanvas = (width, height) => {
            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            const imageData = ctx.createImageData(width, height);
            for (let i = 0; i < imageData.data.length; i += 4) {
                imageData.data[i] = imageData.data[i + 1] = imageData.data[i + 2] = imageData.data[i + 3] = 0;
            }
            ctx.putImageData(imageData, 0, 0);
            canvas.toBlob(blob => {
                const img = new Image();
                const url = URL.createObjectURL(blob);
                activeBlobURLs.add(url);
                img.onload = () => {
                    originalImage = img;
                    resetImage();
                    ui.uz.style.display = 'none';
                    ui.canvas_create_ui.classList.add('hidden');
                    ui.canvas.style.display = 'block';
                    ui.c_clear.disabled = ui.c_reset.disabled = ui.c_apply.disabled = false;
                    URL.revokeObjectURL(url);
                    activeBlobURLs.delete(url);
                };
                img.src = url;
            });
        };

        const loadImage = file => {
            const reader = new FileReader();
            reader.onload = e => {
                const img = new Image();
                img.onload = () => {
                    originalImage = img;
                    resetImage();
                    ui.uz.style.display = 'none';
                    ui.canvas_create_ui.classList.add('hidden');
                    ui.canvas.style.display = 'block';
                    ui.c_clear.disabled = ui.c_reset.disabled = ui.c_apply.disabled = false;
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        };

        const resetImage = () => {
            if (!originalImage) return;
            ui.canvas.width = originalImage.width;
            ui.canvas.height = originalImage.height;
            const ctx = ui.canvas.getContext('2d');
            ctx.drawImage(originalImage, 0, 0);
            originalImageData = ctx.getImageData(0, 0, ui.canvas.width, ui.canvas.height);
        };

        const processImage = () => {
            if (!originalImageData) return;
            saveCurrentFilterCode();
            try {
                const ctx = ui.canvas.getContext('2d');
                let currentImageData = new Uint8ClampedArray(originalImageData.data);
                const width = ui.canvas.width, height = ui.canvas.height;

                filters.forEach(filter => {
                    if (!filter.on) return;
                    const outputData = ctx.createImageData(width, height);
                    for (let i = 0; i < outputData.data.length; i += 4) {
                        outputData.data[i] = outputData.data[i + 1] = outputData.data[i + 2] = 0;
                        outputData.data[i + 3] = 255;
                    }
                    
                    const pixels = currentImageData;
                    const put = (r, g, b, a, x, y) => {
                        const targetX = Math.floor(x), targetY = Math.floor(y);
                        if (targetX >= 0 && targetX < width && targetY >= 0 && targetY < height) {
                            const targetIndex = (targetY * width + targetX) * 4;
                            outputData.data[targetIndex] = Math.max(0, Math.min(255, r));
                            outputData.data[targetIndex + 1] = Math.max(0, Math.min(255, g));
                            outputData.data[targetIndex + 2] = Math.max(0, Math.min(255, b));
                            outputData.data[targetIndex + 3] = Math.max(0, Math.min(255, a));
                        }
                    };
                    
                    const processPixel = new Function('r', 'g', 'b', 'a', 'x', 'y', 'w', 'h', 'i', 'p', 'put', filter.data);
                    for (let i = 0; i < pixels.length; i += 4) {
                        const x = (i / 4) % width, y = Math.floor((i / 4) / width);
                        try {
                            processPixel(pixels[i], pixels[i + 1], pixels[i + 2], pixels[i + 3], x, y, width, height, i, pixels, put);
                        } catch (e) {}
                    }
                    currentImageData = new Uint8ClampedArray(outputData.data);
                });
                
                const finalImageData = ctx.createImageData(width, height);
                finalImageData.data.set(currentImageData);
                ctx.putImageData(finalImageData, 0, 0);
            } catch (error) {
                alert('Error processing image: ' + error.message);
            }
        };

        const handleFileImport = (callback, replace = false) => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = e => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = e => {
                    try {
                        const imported = JSON.parse(e.target.result);
                        validateFilters(imported);
                        if (replace) {
                            if (!confirm('Replace all current filters?')) return;
                            filters = imported;
                            currentFilterIdx = 0;
                        } else {
                            filters.push(...imported);
                        }
                        updateFilterSelect();
                        updateFilterList();
                        if (replace) loadFilterCode();
                        alert(replace ? 'All filters imported successfully' : 'Filter(s) imported successfully');
                    } catch (err) {
                        alert('Failed to import: ' + err.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        };

        updateFilterSelect();
        updateFilterList();
        loadFilterCode();

        ui.uz.addEventListener('dragover', e => e.preventDefault());
        ui.uz.addEventListener('drop', e => {
            e.preventDefault();
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) loadImage(file);
        });
        ui.ui.addEventListener('change', e => {
            const file = e.target.files[0];
            if (file) loadImage(file);
        });

        ui.canvas_new.addEventListener('click', () => {
            const dims = ui.canvas_dims.value.split('x');
            if (dims.length !== 2 || !dims[0] || !dims[1]) return alert('Invalid dimensions. Use format: WxH');
            const width = parseInt(dims[0]), height = parseInt(dims[1]);
            if (!Number.isInteger(width) || !Number.isInteger(height) || width <= 0 || height <= 0)
                return alert('Width and height must be positive integers');
            createBlankCanvas(width, height);
        });

        ui.f_select.addEventListener('change', () => {
            saveCurrentFilterCode();
            currentFilterIdx = parseInt(ui.f_select.value);
            loadFilterCode();
        });

        ui.f_new.addEventListener('click', () => {
            const name = prompt('Filter name:', `Filter ${filters.length + 1}`);
            if (!name) return;
            filters.push({name, on: true, data: '// New filter\nput(r, g, b, a, x, y);'});
            updateFilterSelect();
            updateFilterList();
            currentFilterIdx = filters.length - 1;
            ui.f_select.value = currentFilterIdx;
            loadFilterCode();
        });

        ui.f_ck.addEventListener('click', () => {
            if (filters.length === 1) return alert('Cannot remove the last filter');
            if (!confirm(`Remove filter "${filters[currentFilterIdx].name}"?`)) return;
            filters.splice(currentFilterIdx, 1);
            currentFilterIdx = Math.min(currentFilterIdx, filters.length - 1);
            updateFilterSelect();
            updateFilterList();
            loadFilterCode();
        });

        ui.f_manager.addEventListener('click', () => {
            listExpanded = !listExpanded;
            ui.f_list.classList.toggle('expanded', listExpanded);
        });

        ui.f_export.addEventListener('click', () => {
            saveCurrentFilterCode();
            downloadJSON(JSON.stringify([filters[currentFilterIdx]], null, 2), `${filters[currentFilterIdx].name}.json`);
        });

        ui.f_import.addEventListener('click', () => handleFileImport(false));
        ui.c_export.addEventListener('click', () => {
            saveCurrentFilterCode();
            downloadJSON(JSON.stringify(filters, null, 2), 'all-filters.json');
        });
        ui.c_replace.addEventListener('click', () => handleFileImport(true));

        ui.c_clear.addEventListener('click', () => {
            originalImage = originalImageData = null;
            ui.canvas.style.display = 'none';
            ui.uz.style.display = 'block';
            ui.canvas_create_ui.classList.remove('hidden');
            ui.c_clear.disabled = ui.c_reset.disabled = ui.c_apply.disabled = true;
        });

        ui.c_reset.addEventListener('click', resetImage);
        ui.c_apply.addEventListener('click', processImage);

        ui.canvas.addEventListener('contextmenu', e => {
            if (e.shiftKey) return;
            e.preventDefault();
            ui.canvas.toBlob(blob => {
                const url = URL.createObjectURL(blob);
                activeBlobURLs.add(url);
                const a = document.createElement('a');
                a.href = url;
                a.download = `glitched_${Date.now()}.png`;
                a.click();
                setTimeout(() => {
                    URL.revokeObjectURL(url);
                    activeBlobURLs.delete(url);
                }, 100);
            });
        });

        const resizer = $('resizer'), app = $('app');
        let isResizing = false;

        resizer.addEventListener('mousedown', e => {
            if (window.innerWidth <= 768) return;
            isResizing = true;
            document.body.style.cursor = 'col-resize';
            e.preventDefault();
        });

        document.addEventListener('mousemove', e => {
            if (!isResizing || window.innerWidth <= 768) return;
            const appRect = app.getBoundingClientRect();
            const percentage = ((e.clientX - appRect.left) / appRect.width) * 100;
            if (percentage >= 20 && percentage <= 80) {
                app.style.gridTemplateColumns = `${percentage}% ${100 - percentage}%`;
                resizer.style.left = `${percentage}%`;
            }
        });

        document.addEventListener('mouseup', () => {
            if (isResizing) {
                isResizing = false;
                document.body.style.cursor = 'default';
            }
        });

        window.addEventListener('beforeunload', () => activeBlobURLs.forEach(url => URL.revokeObjectURL(url)));

        const moveFilterUp = (idx) => {
            if (idx <= 0) return;
            const currentFilterName = filters[currentFilterIdx].name;
            [filters[idx - 1], filters[idx]] = [filters[idx], filters[idx - 1]];
            currentFilterIdx = filters.findIndex(f => f.name === currentFilterName);
            updateFilterSelect();
            updateFilterList();
        };

        const moveFilterDown = (idx) => {
            if (idx >= filters.length - 1) return;
            const currentFilterName = filters[currentFilterIdx].name;
            [filters[idx], filters[idx + 1]] = [filters[idx + 1], filters[idx]];
            currentFilterIdx = filters.findIndex(f => f.name === currentFilterName);
            updateFilterSelect();
            updateFilterList();
        };
    </script>
</body>
</html>
